{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "settingName": {
      "type": "string",
      "defaultValue": "datadog-activity-logs-diagnostic-setting",
      "metadata": {
        "description": "The name of the diagnostic setting"
      }
    },
    "eventHubNamespace": {
      "type": "string",
      "defaultValue": "[concat('datadog-ns-', newGuid())]",
      "metadata": {
        "description": "Name of EventHub namespace, which must be globally unique."
      }
    },
    "eventHubName": {
      "type": "string",
      "defaultValue": "datadog-eventhub",
      "metadata": {
        "description": "Name of Event Hub"
      }
    },
    "functionAppName": {
      "type": "string",
      "defaultValue": "[concat('datadog-functionapp-', newGuid())]",
      "metadata": {
        "description": "The name of the function app "
      }
    },
    "functionName": {
      "type": "string",
      "defaultValue": "datadog-function",
      "metadata": {
        "description": "The name of the function."
      }
    },
    "functionCode": {
      "type": "string",
      "metadata": {
        "description": "Code for the function to run, saved into index.js"
      }
    },
    "apiKey": {
      "type": "string",
      "metadata": {
        "description": "Datadog API key"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Specify a location for the resources."
      }
    },
    "datadogSite": {
      "type": "string",
      "defaultValue": "datadoghq.com",
      "metadata": {
        "description": "Datadog site to send logs"
      }
    },
    "endpointSuffix": {
      "type": "string",
      "defaultValue": "core.windows.net",
      "metadata": {
        "description": "Endpoint suffix for storage account"
      }
    }
  },
  "variables": {
    "subscriptionId": "[subscription().subscriptionId]",
    "ResourceGroupName": "[resourceGroup().Name]",
    "eventHubAuthorizationRuleId": "[concat('/subscriptions/', variables('subscriptionId'), '/resourceGroups/', variables('ResourceGroupName'), '/providers/Microsoft.EventHub/namespaces/', parameters('eventHubNamespace'), '/authorizationRules/RootManageSharedAccessKey')]",
    "monDevOpsTemplatesUrl": "https://raw.githubusercontent.com/olusola-adio-sweaty/sb-devops/master/ArmTemplates/"
  },
  "resources": [
    {
      "name": "eventHubTemplate",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2018-05-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('monDevOpsTemplatesUrl'), 'Datadog/event-hub.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "eventHubNamespace": {
            "value": "[parameters('eventHubNamespace')]"
          },
          "eventHubName": {
            "value": "[parameters('eventHubName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "name": "functionAppTemplate",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2018-05-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('monDevOpsTemplatesUrl'), 'Datadog/function-app.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "eventHubNamespace": {
            "value": "[parameters('eventHubNamespace')]"
          },
          "eventHubName": {
            "value": "[parameters('eventHubName')]"
          },
          "functionAppName": {
            "value": "[parameters('functionAppName')]"
          },
          "functionName": {
            "value": "[parameters('functionName')]"
          },
          "functionCode": {
            "value": "[parameters('functionCode')]"
          },
          "apiKey": {
            "value": "[parameters('apiKey')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "datadogSite": {
            "value": "[parameters('datadogSite')]"
          },
          "endpointSuffix": {
            "value": "[parameters('endpointSuffix')]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments','eventHubTemplate')]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2017-05-01-preview",
      "name": "[parameters('settingName')]",
      "properties": {
        "eventHubAuthorizationRuleId": "[variables('eventHubAuthorizationRuleId')]",
        "eventHubName": "[parameters('eventHubName')]",
        "logs": [
          {
            "category": "Administrative",
            "enabled": true
          },
          {
            "category": "Security",
            "enabled": true
          },
          {
            "category": "ServiceHealth",
            "enabled": true
          },
          {
            "category": "Alert",
            "enabled": true
          },
          {
            "category": "Recommendation",
            "enabled": true
          },
          {
            "category": "Policy",
            "enabled": true
          },
          {
            "category": "Autoscale",
            "enabled": true
          },
          {
            "category": "ResourceHealth",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments','functionAppTemplate')]",
        "[resourceId('Microsoft.Resources/deployments','eventHubTemplate')]"
      ]
    }
  ]
}